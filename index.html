<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <script>
      function isInstagramBrowser() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        return userAgent.indexOf("Instagram") > -1 || userAgent.indexOf("FBAN") > -1 || userAgent.indexOf("FBAV") > -1;
      }

      function showExitOverlay() {
        if (isInstagramBrowser()) {
          const overlay = document.createElement('div');
          overlay.id = 'instagram-overlay';
          overlay.style = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
          `;

          overlay.innerHTML = `
            <div style="background-color: #1a1a1a; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
              <h2 style="color: #0070ba; margin-bottom: 1rem;">Per visualizzare la pagina</h2>
              <p style="color: #e0e0e0; font-size: 1.15rem; line-height: 1.6; margin-bottom: 1rem;">
                Il link non può essere aperto correttamente qui.
              </p>
              <p style="color: #e0e0e0; font-size: 1.15rem; line-height: 1.6; margin-bottom: 1.5rem; text-align: left;">
                Per favore, segui queste istruzioni:
                <br><br>
                1. Clicca sui **tre puntini (...)** o sull'icona di condivisione nell'angolo in alto a destra.
                <br>
                2. Seleziona **"Apri nel browser"** (su iOS) o **"Apri con Chrome"** (su Android).
              </p>
              <button onclick="window.open(window.location.href, '_system');" style="background-color: #ff914d; color: #121212; padding: 1rem 2rem; border: none; border-radius: 0.85rem; font-weight: bold; cursor: pointer; font-size: 1.2rem; transition: background-color 0.3s; width: auto; max-width: 100%;">
                Apri nel browser
              </button>
            </div>
          `;
          document.body.appendChild(overlay);
        }
      }
      
      document.addEventListener('DOMContentLoaded', showExitOverlay);

      let guestCount = 1;
      const maxGuests = 5;

      function addGuestFields() {
        if (guestCount >= maxGuests) {
          alert("Puoi registrare un massimo di 5 ospiti.");
          return;
        }
        guestCount++;
        const container = document.getElementById('guests');
        const div = document.createElement('div');
        div.className = 'guest-block';
        div.innerHTML = `
          <h4>Guest ${guestCount}</h4>
          <label>Nome:</label>
          <input name="name" placeholder="Nome" class="FormC" required>
          <label>Cognome:</label>
          <input name="surname" placeholder="Cognome" class="FormC" required>
          <label>Email:</label>
          <input name="email" placeholder="Email" class="FormC" required>
          <label>Telefono:</label>
          <input name="phone" placeholder="Telefono" class="FormC" required>
          <button type="button" class="remove-btn" onclick="removeGuest(this)">Rimuovi</button>
        `;
        container.appendChild(div);
      }

      function removeGuest(button) {
        const block = button.parentElement;
        block.remove();
        guestCount--;
      }

      function toggleButtons() {
        const selected = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        const paypalBtn = document.getElementById('paypalBtn');
        const offlineBtn = document.getElementById('offlineBtn');

        if (selected === 'paypal') {
          paypalBtn.style.opacity = '1';
          paypalBtn.style.maxHeight = '50px';
          paypalBtn.style.padding = '1.4rem 1.7rem';
          offlineBtn.style.opacity = '0';
          offlineBtn.style.maxHeight = '0';
          offlineBtn.style.padding = '0';
        } else {
          paypalBtn.style.opacity = '0';
          paypalBtn.style.maxHeight = '0';
          paypalBtn.style.padding = '0';
          offlineBtn.style.opacity = '1';
          offlineBtn.style.maxHeight = '50px';
          offlineBtn.style.padding = '1.4rem 1.7rem';
        }
      }
      
      function toggleWarning() {
        const selected = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        const paypalWarning = document.getElementById('paypal-warning');
        if (selected === 'paypal') {
          paypalWarning.classList.add('open');
        } else {
          paypalWarning.classList.remove('open');
        }
      }
      
      function onPaymentChange() {
        toggleButtons();
        toggleWarning();
      }

      // Questo è l'endpoint della tua funzione Netlify.
      // Sostituisce l'URL di Google Apps Script.
      const NETLIFY_FUNCTION_URL = '/.netlify/functions/submit-form';

      async function handleSubmit(event) {
        event.preventDefault(); // Impedisce l'invio tradizionale del form

        const form = document.getElementById('registration-form');
        const guests = Array.from(form.querySelectorAll('.guest-block')).map(block => ({
          name: block.querySelector('[name="name"]').value,
          surname: block.querySelector('[name="surname"]').value,
          email: block.querySelector('[name="email"]').value,
          phone: block.querySelector('[name="phone"]').value,
        }));
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

        if (!paymentMethod) {
          alert("Seleziona un metodo di pagamento.");
          return;
        }
        
        const payload = {
          action: 'submitForm',
          guests: guests,
          paymentMethod: paymentMethod,
        };
        
        try {
          const response = await fetch(NETLIFY_FUNCTION_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();

          if (result.success) {
            const { groupId, paypalUrl } = result.data;
            localStorage.setItem('groupId', groupId);
            
            if (paypalUrl) {
              alert('Registrazione completata! Verrai reindirizzato a PayPal.');
              window.location.href = paypalUrl;
            } else {
              alert('Registrazione completata! La tua ricevuta di pagamento deve ancora essere caricata.');
              window.location.href = 'thankyou.html';
            }
          } else {
            alert('Errore nella registrazione: ' + result.error);
          }
        } catch (error) {
          alert('Errore di rete. Riprova più tardi.');
          console.error('Fetch error:', error);
        }
      }
    </script>
  </head>
  <body>
    <form id="registration-form" onsubmit="handleSubmit(event)">
      <div class="info-block">
        <p class="warning-note">
          <strong>⚠️ Nota Bene: La compilazione del form non garantisce l'inclusione all'evento.
          La partecipazione è ufficializzata solo dopo il versamento del contributo e la successiva ricezione del QR code.</strong>
        </p>
      </div>

      <div id="guests">
        <div class="guest-block">
          <h4>Guest</h4>
          <label>Nome:</label>
          <input name="name" placeholder="Nome" class="FormC" required>
          <label>Cognome:</label>
          <input name="surname" placeholder="Cognome" class="FormC" required>
          <label>Email:</label>
          <input name="email" placeholder="Email" class="FormC" required>
          <label>Telefono:</label>
          <input name="phone" placeholder="Telefono" class="FormC" required>
        </div>
      </div>
      
      <div class="button-container">
          <button type="button" onclick="addGuestFields()">+ Aggiungi Guest</button>
      </div>

      <h3 style="margin-top: 2.5rem;">Metodo di pagamento</h3>
      <div class="payment-options">
        <label class="payment-option">
          <input type="radio" name="paymentMethod" value="paypal" onchange="onPaymentChange()"> <span>PayPal</span>
        </label>
        <div id="paypal-warning" class="warning-dropdown">
            <p>Ti preghiamo di spuntare la voce "Amici e Familiari". Il contributo includerà tutti gli ospiti che hai registrato nel form di cui sopra.</p>
        </div>
        <label class="payment-option">
          <input type="radio" name="paymentMethod" value="revolut" onchange="onPaymentChange()"> <span>Revolut / Carta di Credito</span>
        </label>
        <label class="payment-option">
          <input type="radio" name="paymentMethod" value="satispay" onchange="onPaymentChange()"> <span>Satispay</span>
        </label>
      </div>

      <label style="margin-top:20px; font-weight:normal; text-align: left;"><input type="checkbox" required> Acconsento al trattamento dei miei dati per l'organizzazione dell'evento e all'utilizzo della mia immagine (foto/video) sui canali di comunicazione di Parea.</label>

      <div class="button-container payment-button-container">
          <button type="submit" id="paypalBtn" class="payment-button">Paga con PayPal</button>
          <button type="submit" id="offlineBtn" class="payment-button hidden">Paga Offline</button>
      </div>
    </form>
    
    <div class="info-block">
        <h4>🔗 Link e Contatti</h4>
        <p>Seguici per non perderti news, storie e foto dei nostri eventi!</p>
        <div class="button-container">
            <a href="https://www.instagram.com/lostinparea?igsh=NTI3Y3VjM3AwNWVl" target="_blank">
                <button type="button">Instagram</button>
            </a>
        </div>
        <p style="margin-top: 1.5rem;">Entra nella Community WhatsApp ufficiale per aggiornamenti in tempo reale.</p>
        <div class="button-container">
            <a href="https://chat.whatsapp.com/EOfaTPumoLv6alEZxCAVCs?mode=ac_t" target="_blank">
                <button type="button">Whatsapp Community</button>
            </a>
        </div>
        <p style="margin-top: 1.5rem;">Hai ancora qualche dubbio? Siamo qui per aiutarti.</p>
        <div class="button-container">
            <a href="https://ig.me/m/lostinparea" target="_blank">
                <button type="button">Contattaci</button>
            </a>
        </div>
    </div>
  </body>
</html>